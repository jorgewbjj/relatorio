<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Reportes Técnicos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- jsPDF e html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { background: #f6f6fa; font-family: Inter, Arial, sans-serif; margin: 0; }
    .container { max-width: 820px; margin: 30px auto; background: #fff; border-radius: 16px; padding: 28px 22px; box-shadow: 0 2px 14px #d3e0ee50; }
    h2 { color: #2266ee; margin: 0 0 18px 0; }
    .row { display: flex; gap: 16px; margin-bottom: 14px; flex-wrap: wrap;}
    .row > .field { flex: 1; min-width: 140px;}
    label { font-weight: 500; color: #666; margin-bottom: 4px; display: block;}
    input, textarea, select { width: 100%; padding: 10px 12px; background: #f3f4f8; border: 1px solid #e1e1e9; border-radius: 8px; font-size: 1rem; margin-bottom: 2px;}
    input:focus, textarea:focus, select:focus { border-color: #2266ee;}
    textarea { min-height: 45px;}
    .problema-card { background: #f9faff; border: 1px solid #e1e1e9; border-radius: 10px; margin-bottom: 16px; padding: 14px; position: relative;}
    .remove-btn { position: absolute; top: 8px; right: 8px; border: none; background: none; font-size: 1.2rem; color: #d33; cursor: pointer; }
    .remove-btn:hover { background: #fdeaea;}
    .add-btn, .submit-btn, .pdf-btn { background: #2266ee; color: #fff; border: none; padding: 10px 24px; border-radius: 9px; cursor: pointer; font-weight: 600; margin-top: 8px; margin-right: 6px;}
    .add-btn:hover, .submit-btn:hover, .pdf-btn:hover { background: #1143bb;}
    .listagem { margin-top: 32px;}
    .card-reporte { background: #fafbff; border-radius: 9px; border: 1px solid #e1e1e9; margin-bottom: 16px; padding: 12px 16px; display: flex; flex-direction: column;}
    .card-reporte span { font-size: 1.05em; color: #444;}
    .botoes { margin-top: 10px;}
    .botoes button { margin-right: 7px; }
    .card-reporte.active { border: 2px solid #2266ee; background: #eef2ff;}
    @media (max-width: 700px) { .container {padding: 16px 3vw;} }
    @media (max-width: 540px) { .row {flex-direction: column; gap: 7px;} }
  </style>
</head>
<body>
  <div class="container">
    <h2>Reporte Técnico</h2>
    <form id="reporteForm" autocomplete="off">
      <input type="hidden" id="reporteId" value="">
      <div class="row">
        <div class="field">
          <label for="data">Data</label>
          <input type="date" id="data" name="data" required>
        </div>
        <div class="field">
          <label for="tecnico">Técnico</label>
          <input type="text" id="tecnico" name="tecnico" required>
        </div>
        <div class="field">
          <label for="cliente">Cliente</label>
          <input type="text" id="cliente" name="cliente" required>
        </div>
      </div>
      <div id="problemasContainer"></div>
      <button type="button" class="add-btn" onclick="adicionarProblema()">+ Adicionar Problema</button>
      <button type="submit" class="submit-btn">Salvar Reporte</button>
    </form>

    <div class="listagem">
      <h3>Reportes Salvos</h3>
      <div id="listaReportes"></div>
    </div>
  </div>

  <template id="problemaTemplate">
    <div class="problema-card">
      <button type="button" class="remove-btn" onclick="removerProblema(this)">×</button>
      <div class="row">
        <div class="field">
          <label>Problema / Situação / Teste</label>
          <input type="text" name="problema[]" required>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Observações</label>
          <textarea name="observacoes[]"></textarea>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Resultado</label>
          <select name="resultado[]" required>
            <option value="" disabled selected>Selecione</option>
            <option value="Bom">Bom</option>
            <option value="Liberado com restrição">Liberado com restrição</option>
            <option value="Reprovado">Reprovado</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Observação do Resultado</label>
          <textarea name="obs_resultado[]"></textarea>
        </div>
      </div>
    </div>
  </template>

  <script>
    // CONFIGURE AQUI O SEU FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyDckXEwRF2Fh0rQT_S9BZlSPZ5xwYJMgtw",
  authDomain: "relatoriohanier.firebaseapp.com",
  projectId: "relatoriohanier",
  storageBucket: "relatoriohanier.firebasestorage.app",
  messagingSenderId: "606553696365",
  appId: "1:606553696365:web:4c95e03fd3fa831eb4f764"
};

    // Inicialização Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Utils
    function uuid() {
      return Math.random().toString(36).substr(2, 9) + Date.now();
    }

    // Adiciona problema no formulário
    function adicionarProblema(problemaData = null) {
      const template = document.getElementById('problemaTemplate');
      const clone = template.content.cloneNode(true);
      if (problemaData) {
        const inputs = clone.querySelectorAll('input, textarea, select');
        inputs[0].value = problemaData.problema;
        inputs[1].value = problemaData.observacoes;
        inputs[2].value = problemaData.resultado;
        inputs[3].value = problemaData.obs_resultado;
      }
      document.getElementById('problemasContainer').appendChild(clone);
    }
    function removerProblema(btn) {
      btn.closest('.problema-card').remove();
    }

    // Ao carregar, seta data de hoje e pelo menos um problema
    window.onload = function() {
      let today = new Date().toISOString().substr(0, 10);
      document.getElementById('data').value = today;
      adicionarProblema();
      carregarReportes();
    };

    // Salvar ou atualizar reporte
    document.getElementById('reporteForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('reporteId').value || uuid();
      const data = document.getElementById('data').value;
      const tecnico = document.getElementById('tecnico').value;
      const cliente = document.getElementById('cliente').value;
      const problemas = [];
      document.querySelectorAll('#problemasContainer .problema-card').forEach(card => {
        const inputs = card.querySelectorAll('input, textarea, select');
        problemas.push({
          problema: inputs[0].value,
          observacoes: inputs[1].value,
          resultado: inputs[2].value,
          obs_resultado: inputs[3].value
        });
      });
      db.ref('reportes/' + id).set({
        id, data, tecnico, cliente, problemas
      }, (err) => {
        if (!err) {
          alert('Reporte salvo!');
          this.reset();
          document.getElementById('problemasContainer').innerHTML = '';
          document.getElementById('reporteId').value = '';
          document.getElementById('data').value = new Date().toISOString().substr(0, 10);
          adicionarProblema();
          carregarReportes();
        } else {
          alert('Erro ao salvar.');
        }
      });
    });

    // Carregar reportes antigos
    function carregarReportes() {
      db.ref('reportes').once('value', snap => {
        const lista = document.getElementById('listaReportes');
        lista.innerHTML = '';
        if (!snap.exists()) {
          lista.innerHTML = '<i>Nenhum reporte salvo ainda.</i>';
          return;
        }
        Object.values(snap.val()).sort((a, b) => b.data.localeCompare(a.data)).forEach(rep => {
          const div = document.createElement('div');
          div.className = 'card-reporte';
          div.innerHTML = `
            <span><b>Data:</b> ${rep.data} | <b>Técnico:</b> ${rep.tecnico} | <b>Cliente:</b> ${rep.cliente}</span>
            <span><b>Problemas:</b> ${rep.problemas.length}</span>
            <div class="botoes">
              <button onclick='editarReporte("${rep.id}")'>Editar</button>
              <button class="pdf-btn" onclick='gerarPDFReporte("${rep.id}")'>Exportar PDF</button>
            </div>
          `;
          lista.appendChild(div);
        });
      });
    }

    // Editar reporte (preenche o formulário)
    window.editarReporte = function(id) {
      db.ref('reportes/' + id).once('value', snap => {
        if (!snap.exists()) return;
        const rep = snap.val();
        document.getElementById('reporteId').value = rep.id;
        document.getElementById('data').value = rep.data;
        document.getElementById('tecnico').value = rep.tecnico;
        document.getElementById('cliente').value = rep.cliente;
        document.getElementById('problemasContainer').innerHTML = '';
        rep.problemas.forEach(prob => adicionarProblema(prob));
        window.scrollTo({top:0,behavior:'smooth'});
      });
    };

    // Gerar PDF
    window.gerarPDFReporte = function(id) {
      db.ref('reportes/' + id).once('value', snap => {
        if (!snap.exists()) return;
        const rep = snap.val();
        // Gera HTML temporário para PDF
        const tempDiv = document.createElement('div');
        tempDiv.style.padding = '20px';
        tempDiv.style.maxWidth = '680px';
        tempDiv.innerHTML = `
          <h2 style="color:#2266ee">Reporte Técnico</h2>
          <div><b>Data:</b> ${rep.data}</div>
          <div><b>Técnico:</b> ${rep.tecnico}</div>
          <div><b>Cliente:</b> ${rep.cliente}</div>
          <br>
          <div>
            ${rep.problemas.map((p,i) => `
              <div style="margin-bottom:18px; border-bottom:1px solid #ddd; padding-bottom:10px;">
                <b>Problema ${i+1}:</b> ${p.problema}<br>
                <b>Observações:</b> ${p.observacoes || "-"}<br>
                <b>Resultado:</b> ${p.resultado}<br>
                <b>Obs. Resultado:</b> ${p.obs_resultado || "-"}
              </div>
            `).join('')}
          </div>
        `;
        document.body.appendChild(tempDiv);
        html2canvas(tempDiv, {scale:2}).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new window.jspdf.jsPDF({orientation:'p',unit:'pt',format:'a4'});
          const pageWidth = pdf.internal.pageSize.getWidth();
          const imgWidth = pageWidth - 40;
          const imgHeight = canvas.height * imgWidth / canvas.width;
          pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
          pdf.save('reporte_'+rep.data+'.pdf');
          tempDiv.remove();
        });
      });
    };

  </script>
</body>
</html>
