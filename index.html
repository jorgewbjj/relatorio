

  <!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Reportes Técnicos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background: #f6f6fa; font-family: Inter, Arial, sans-serif; margin: 0; }
    .container { max-width: 860px; margin: 30px auto; background: #fff; border-radius: 16px; padding: 28px 22px; box-shadow: 0 2px 14px #d3e0ee50; }
    h2 { color: #2266ee; margin: 0 0 18px 0; }
    .row { display: flex; gap: 16px; margin-bottom: 14px; flex-wrap: wrap;}
    .row > .field { flex: 1; min-width: 140px;}
    label { font-weight: 500; color: #666; margin-bottom: 4px; display: block;}
    input, textarea, select { width: 100%; padding: 10px 12px; background: #f3f4f8; border: 1px solid #e1e1e9; border-radius: 8px; font-size: 1rem; margin-bottom: 2px;}
    input:focus, textarea:focus, select:focus { border-color: #2266ee;}
    textarea { min-height: 45px;}
    .problema-card { background: #f9faff; border: 1px solid #e1e1e9; border-radius: 10px; margin-bottom: 16px; padding: 14px; position: relative;}
    .remove-btn { position: absolute; top: 8px; right: 8px; border: none; background: none; font-size: 1.2rem; color: #d33; cursor: pointer; }
    .remove-btn:hover { background: #fdeaea;}
    .foto-thumb { display:inline-block; margin-top:5px; max-width:80px; max-height:60px; border-radius:7px; border:1px solid #ddd;}
    .add-btn, .submit-btn, .pdf-btn { background: #2266ee; color: #fff; border: none; padding: 10px 24px; border-radius: 9px; cursor: pointer; font-weight: 600; margin-top: 8px; margin-right: 6px;}
    .add-btn:hover, .submit-btn:hover, .pdf-btn:hover { background: #1143bb;}
    .listagem { margin-top: 32px;}
    .card-reporte { background: #fafbff; border-radius: 9px; border: 1px solid #e1e1e9; margin-bottom: 16px; padding: 12px 16px; display: flex; flex-direction: column;}
    .card-reporte span { font-size: 1.05em; color: #444;}
    .botoes { margin-top: 10px;}
    .botoes button { margin-right: 7px; }
    .card-reporte.active { border: 2px solid #2266ee; background: #eef2ff;}
    @media (max-width: 700px) { .container {padding: 16px 3vw;} }
    @media (max-width: 540px) { .row {flex-direction: column; gap: 7px;} }
  </style>
</head>
<body>
  <div class="container">
    <h2>Reporte Técnico</h2>
    <form id="reporteForm" autocomplete="off">
      <input type="hidden" id="reporteId" value="">
      <div class="row">
        <div class="field">
          <label for="data">Data</label>
          <input type="date" id="data" name="data" required>
        </div>
        <div class="field">
          <label for="tecnico">Técnico</label>
          <select id="tecnico" name="tecnico" required>
            <option value="" disabled selected>Selecione</option>
            <option>Jorge Woicikoski</option>
            <option>Daniel Cunha</option>
            <option>Adriano Madalena</option>
            <option>Odair Konnel</option>
            <option>Felipe Moreira</option>
          </select>
        </div>
        <div class="field">
          <label for="cliente">Cliente</label>
          <select id="cliente" name="cliente" required>
            <option value="" disabled selected>Selecione</option>
            <option>Karsten</option>
            <option>Luli Malhas</option>
            <option>Suvicor</option>
            <option>Rovitex</option>
            <option>Benvetex</option>
            <option>RVB</option>
            <option>Nanete</option>
          </select>
        </div>
      </div>
      <div id="problemasContainer"></div>
      <button type="button" class="add-btn" id="btnAddProblema">+ Adicionar Problema</button>
      <button type="submit" class="submit-btn">Salvar Reporte</button>
    </form>

    <div class="listagem">
      <h3>Reportes Salvos</h3>
      <div id="listaReportes"></div>
    </div>
  </div>

  <template id="problemaTemplate">
    <div class="problema-card">
      <button type="button" class="remove-btn" onclick="removerProblema(this)">×</button>
      <div class="row">
        <div class="field">
          <label>Problema / Situação / Teste</label>
          <input type="text" name="problema[]" required>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Observações</label>
          <textarea name="observacoes[]"></textarea>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Resultado</label>
          <select name="resultado[]" required>
            <option value="" disabled selected>Selecione</option>
            <option value="Bom">Bom</option>
            <option value="Liberado com restrição">Liberado com restrição</option>
            <option value="Reprovado">Reprovado</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Observação do Resultado</label>
          <textarea name="obs_resultado[]"></textarea>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Foto (opcional)</label>
          <input type="file" name="foto[]" accept="image/*" onchange="previewFoto(this)">
          <img class="foto-thumb" style="display:none;">
        </div>
      </div>
    </div>
  </template>

  <script>
    // CONFIGURE AQUI O SEU FIREBASE
  apiKey: "AIzaSyDckXEwRF2Fh0rQT_S9BZlSPZ5xwYJMgtw",
  authDomain: "relatoriohanier.firebaseapp.com",
  projectId: "relatoriohanier",
  storageBucket: "relatoriohanier.firebasestorage.app",
  messagingSenderId: "606553696365",
  appId: "1:606553696365:web:4c95e03fd3fa831eb4f764"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // Gera um ID único simples
    function uuid() {
      return Math.random().toString(36).substr(2, 9) + Date.now();
    }

    // Adiciona card de problema (opcionalmente preenchido)
    function adicionarProblema(problemaData = null) {
      const template = document.getElementById('problemaTemplate');
      const clone = template.content.cloneNode(true);

      if (problemaData) {
        const inputs = clone.querySelectorAll('input[type="text"], textarea, select');
        inputs[0].value = problemaData.problema;
        inputs[1].value = problemaData.observacoes;
        inputs[2].value = problemaData.resultado;
        inputs[3].value = problemaData.obs_resultado;
        if (problemaData.fotoUrl) {
          const img = clone.querySelector('.foto-thumb');
          img.src = problemaData.fotoUrl;
          img.style.display = 'inline-block';
        }
      }
      document.getElementById('problemasContainer').appendChild(clone);
    }

    function removerProblema(btn) {
      const container = document.getElementById('problemasContainer');
      // Garante que ao menos 1 problema fique no formulário
      if (container.querySelectorAll('.problema-card').length > 1) {
        btn.closest('.problema-card').remove();
      } else {
        alert('O reporte deve conter pelo menos um problema.');
      }
    }

    // Mostra a prévia da foto no card
    function previewFoto(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = input.parentNode.querySelector('.foto-thumb');
          img.src = e.target.result;
          img.style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
      }
    }

    // Adiciona pelo menos um problema ao abrir
    window.onload = function() {
      let today = new Date().toISOString().substr(0, 10);
      document.getElementById('data').value = today;
      document.getElementById('problemasContainer').innerHTML = '';
      adicionarProblema();
      carregarReportes();
    };

    // Garante que sempre exista ao menos um card de problema
    document.getElementById('btnAddProblema').onclick = function() {
      adicionarProblema();
    };

    // Envia formulário (salva no Realtime DB e Storage)
    document.getElementById('reporteForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const id = document.getElementById('reporteId').value || uuid();
      const data = document.getElementById('data').value;
      const tecnico = document.getElementById('tecnico').value;
      const cliente = document.getElementById('cliente').value;
      const problemas = [];
      const problemasCards = document.querySelectorAll('#problemasContainer .problema-card');

      for (let i = 0; i < problemasCards.length; i++) {
        const card = problemasCards[i];
        const inputs = card.querySelectorAll('input[type="text"], textarea, select, input[type="file"]');
        let fotoUrl = '';
        const fileInput = inputs[4];
        if (fileInput && fileInput.files.length) {
          const file = fileInput.files[0];
          const storageRef = storage.ref(`reportes/${id}/problema${i}_${file.name}`);
          await storageRef.put(file);
          fotoUrl = await storageRef.getDownloadURL();
        } else if (card.querySelector('.foto-thumb') && card.querySelector('.foto-thumb').src && !card.querySelector('.foto-thumb').src.startsWith('data:')) {
          fotoUrl = card.querySelector('.foto-thumb').src;
        }
        problemas.push({
          problema: inputs[0].value,
          observacoes: inputs[1].value,
          resultado: inputs[2].value,
          obs_resultado: inputs[3].value,
          fotoUrl: fotoUrl || ""
        });
      }

      db.ref('reportes/' + id).set({
        id, data, tecnico, cliente, problemas
      }, (err) => {
        if (!err) {
          alert('Reporte salvo!');
          this.reset();
          document.getElementById('problemasContainer').innerHTML = '';
          document.getElementById('reporteId').value = '';
          document.getElementById('data').value = new Date().toISOString().substr(0, 10);
          adicionarProblema();
          carregarReportes();
        } else {
          alert('Erro ao salvar.');
        }
      });
    });

    // Lista todos os reportes salvos
    function carregarReportes() {
      db.ref('reportes').once('value', snap => {
        const lista = document.getElementById('listaReportes');
        lista.innerHTML = '';
        if (!snap.exists()) {
          lista.innerHTML = '<i>Nenhum reporte salvo ainda.</i>';
          return;
        }
        Object.values(snap.val()).sort((a, b) => b.data.localeCompare(a.data)).forEach(rep => {
          const div = document.createElement('div');
          div.className = 'card-reporte';
          div.innerHTML = `
            <span><b>Data:</b> ${rep.data} | <b>Técnico:</b> ${rep.tecnico} | <b>Cliente:</b> ${rep.cliente}</span>
            <span><b>Problemas:</b> ${rep.problemas.length}</span>
            <div class="botoes">
              <button onclick='editarReporte("${rep.id}")'>Editar</button>
              <button class="pdf-btn" onclick='gerarPDFReporte("${rep.id}")'>Exportar PDF</button>
            </div>
          `;
          lista.appendChild(div);
        });
      });
    }

    // Preenche o formulário para edição
    window.editarReporte = function(id) {
      db.ref('reportes/' + id).once('value', snap => {
        if (!snap.exists()) return;
        const rep = snap.val();
        document.getElementById('reporteId').value = rep.id;
        document.getElementById('data').value = rep.data;
        document.getElementById('tecnico').value = rep.tecnico;
        document.getElementById('cliente').value = rep.cliente;
        document.getElementById('problemasContainer').innerHTML = '';
        rep.problemas.forEach(prob => adicionarProblema(prob));
        window.scrollTo({top:0,behavior:'smooth'});
      });
    };

    // Auxiliar: converte imagem para base64
    function getBase64ImageFromUrl(url) {
      return fetch(url)
        .then(response => response.blob())
        .then(blob => new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        }));
    }

    // Gera o PDF (com as imagens do storage!)
    window.gerarPDFReporte = async function(id) {
      db.ref('reportes/' + id).once('value', async snap => {
        if (!snap.exists()) return;
        const rep = snap.val();

        const pdf = new window.jspdf.jsPDF({orientation:'p',unit:'pt',format:'a4'});
        let y = 30;

        pdf.setFontSize(20);
        pdf.setTextColor(34,102,238);
        pdf.text('Reporte Técnico', 40, y);
        y += 32;

        pdf.setFontSize(12);
        pdf.setTextColor(0,0,0);
        pdf.text(`Data: ${rep.data}`, 40, y);
        y += 18;
        pdf.text(`Técnico: ${rep.tecnico}`, 40, y);
        y += 18;
        pdf.text(`Cliente: ${rep.cliente}`, 40, y);
        y += 26;

        for (let i = 0; i < rep.problemas.length; i++) {
          const p = rep.problemas[i];
          pdf.setFont(undefined, 'bold');
          pdf.text(`Problema ${i+1}:`, 40, y);
          pdf.setFont(undefined, 'normal');
          y += 14;
          pdf.text(`Descrição: ${p.problema}`, 50, y); y += 14;
          pdf.text(`Observações: ${p.observacoes || "-"}`, 50, y); y += 14;
          pdf.text(`Resultado: ${p.resultado}`, 50, y); y += 14;
          pdf.text(`Obs. Resultado: ${p.obs_resultado || "-"}`, 50, y); y += 8;

          if (p.fotoUrl) {
            y += 6;
            pdf.text("Foto:", 50, y); y += 2;
            try {
              const imgBase64 = await getBase64ImageFromUrl(p.fotoUrl);
              pdf.addImage(imgBase64, 'JPEG', 60, y, 90, 65);
              y += 75;
            } catch (e) {
              y += 10;
            }
          } else {
            y += 14;
          }
          y += 8;
          if (y > 720) {
            pdf.addPage();
            y = 40;
          }
        }

        pdf.save('reporte_'+rep.data+'.pdf');
      });
    };
  </script>
</body>
</html>
